# Corrupt Video Inspector

A Docker-based tool to detect and report corrupt video files using FFmpeg.

## Quick Start

This project was generated by the `setup_and_run.sh` script and includes everything needed to run in Docker.

### Usage

**Scan videos in a directory:**
```bash
./run.sh scan /path/to/your/videos
```

**List videos only:**
```bash
./run.sh list /path/to/your/videos
```

**Interactive mode:**
```bash
./run.sh interactive /path/to/your/videos
```

### Direct Python Usage

**Install the package:**
```bash
pip install -e .
```

**Run a scan:**
```bash
python3 cli_handler.py /path/to/your/videos
corrupt-video-inspector /path/to/your/videos
```

**Sync to Trakt.tv watchlist:**
```bash
# First, scan your videos with JSON output
python3 cli_handler.py --json /path/to/your/videos

# Then sync results to Trakt watchlist (automatic mode)
python3 cli_handler.py trakt corruption_scan_results.json --token YOUR_TRAKT_TOKEN

# Or use interactive mode to manually select matches
python3 cli_handler.py trakt corruption_scan_results.json --token YOUR_TRAKT_TOKEN --interactive
```

### Direct Docker Usage

**Build the image:**
```bash
docker build -t corrupt-video-inspector .
```

**Run a scan:**
```bash
docker run --rm \
  -v /path/to/your/videos:/app/videos:ro \
  -v $(pwd)/output:/app/output \
  corrupt-video-inspector \
  python3 cli_handler.py --verbose --json /app/videos
```

### Development

**Install development dependencies:**
```bash
pip install -e ".[dev]"
```

**Set up pre-commit hooks (recommended for contributors):**
```bash
make pre-commit-install
# or manually:
pre-commit install
```

Pre-commit hooks will automatically run formatting, linting, and type checking before each commit to ensure code quality and consistency. These hooks help maintain consistent code style, catch potential bugs early, and enforce type safety across all contributions. See [CONTRIBUTING.md](CONTRIBUTING.md) for detailed setup instructions.

**Run formatting and linting:**
```bash
make format  # Format code with black
make lint    # Lint code with ruff
make type    # Type check with mypy
make check   # Run all checks
```

**Run tests:**
```bash
make test    # Run integration tests
```

**Or manually:**
```bash
black .
ruff check .
mypy .
python3 tests/run_tests.py  # Run integration tests
```

**Development with Docker:**

For a complete development environment using Docker:

```bash
# Start development environment (uses Docker profiles)
make docker-dev

# Connect to development container
docker exec -it video-dev /bin/bash

# Stop development environment
docker compose --profile dev down
```

**Development with VS Code Dev Containers:**

This project includes a `.devcontainer` configuration for VS Code:

1. Install the [Dev Containers extension](https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-containers)
2. Open the project in VS Code
3. Press `Ctrl+Shift+P` (or `Cmd+Shift+P` on Mac)
4. Select "Dev Containers: Reopen in Container"

The development container includes:
- All necessary system dependencies (Python, FFmpeg, git, etc.)
- Development tools (black, ruff, mypy, pytest)
- Source code bind-mounted for live editing
- Pre-configured VS Code settings and extensions

**Docker Profiles:**

This project uses Docker Compose profiles:

- **Production (default)**: `docker compose up` - Uses production Dockerfile
- **Development**: `docker compose --profile dev up` - Uses development Dockerfile with bind mounts

### Features

- Multi-threaded video processing
- FFmpeg-based corruption detection
- JSON output with detailed results
- **Resume functionality for interrupted scans using Write-Ahead Log (WAL)**
- **Signal-based progress reporting (SIGUSR1, SIGUSR2, SIGTERM)**
- **Durable result files for persistent scan history**
- **Configurable logging with multiple output options**
- Recursive directory scanning
- File extension filtering
- Progress tracking
- Hybrid scan mode (quick + deep scan for suspicious files)
- **Trakt.tv watchlist integration for automatic media syncing**
- Comprehensive integration testing

### Logging Configuration

The Corrupt Video Inspector includes robust logging capabilities that can be configured via environment variables:

**Environment Variables:**
- `CORRUPT_VIDEO_INSPECTOR_LOG_LEVEL`: Set log level (`DEBUG`, `INFO`, `WARNING`, `ERROR`)
- `CORRUPT_VIDEO_INSPECTOR_LOG_FILE`: Set log file path for persistent logging
- `CORRUPT_VIDEO_INSPECTOR_LOG_FORMAT`: Set custom log format

**Examples:**
```bash
# Enable debug logging
export CORRUPT_VIDEO_INSPECTOR_LOG_LEVEL=DEBUG
python3 cli_handler.py /path/to/videos

# Log to file
export CORRUPT_VIDEO_INSPECTOR_LOG_FILE=/var/log/video-inspector.log
python3 cli_handler.py /path/to/videos

# Custom log format (simple)
export CORRUPT_VIDEO_INSPECTOR_LOG_FORMAT='%(levelname)s: %(message)s'
python3 cli_handler.py /path/to/videos

# Combined configuration
export CORRUPT_VIDEO_INSPECTOR_LOG_LEVEL=INFO
export CORRUPT_VIDEO_INSPECTOR_LOG_FILE=/tmp/scan.log
python3 cli_handler.py --verbose /path/to/videos
```

**Default Behavior:**
- Console output goes to `stderr` to avoid interfering with scan results
- Log level defaults to `INFO`, or `DEBUG` with `--verbose`, or `ERROR` with `--quiet`
- Messages are logged alongside existing console output for optimal user experience

### Signal-Based Progress Reporting

The Corrupt Video Inspector now supports real-time progress reporting via POSIX signals:

**View current progress:**
```bash
# Send SIGUSR1 or SIGUSR2 to the running process
kill -USR1 <process_id>
kill -USR2 <process_id>
```

The progress report includes:
- Current file being processed
- Total files processed and remaining
- Number of corrupt files found
- Elapsed time and estimated time remaining
- Scan mode information

**Example output:**
```
============================================================
PROGRESS REPORT (Signal SIGUSR1)
============================================================
Scan Mode: HYBRID
Current File: video_sample.mp4
Files Processed: 45/100
Corrupt Files Found: 3
Healthy Files: 42
Files Remaining: 55
Elapsed Time: 139.6 seconds
Estimated Time Remaining: 170.7 seconds
============================================================
```

### Output

Results are saved to the `output` directory and temporary files:
- Console output with summary
- JSON file with detailed results (if --json flag used)
- Progress tracking during scan
- **Write-Ahead Log (WAL) files in system temp directory for resume functionality**
- **Durable result files preserving scan history after completion**

**WAL and Results Files:**
- WAL files: `corrupt_video_inspector_wal_<hash>.json` - Used for resuming interrupted scans
- Results files: `corrupt_video_inspector_results_<hash>.json` - Persistent record of all processed files
- Both files are automatically created in the system temporary directory
- WAL files are cleaned up after successful completion, results files are preserved

### Supported Formats

- MP4, AVI, MKV, MOV, WMV, FLV, WebM, M4V, MPG, MPEG, 3GP, ASF

### Resume Functionality

The tool automatically saves progress during scans using a Write-Ahead Log (WAL) file. If a scan is interrupted:

- **Automatic Resume**: Simply re-run the same command - the tool will detect the incomplete scan and resume from where it left off
- **Progress Recovery**: All previously processed files are skipped, saving time on large directories
- **Disable Resume**: Use `--no-resume` flag to start fresh and ignore any existing progress
- **WAL Cleanup**: The WAL file is automatically deleted after successful completion

**Example resume scenario:**
```bash
# Start a scan that gets interrupted
python3 cli_handler.py /large/video/directory

# Resume the scan automatically
python3 cli_handler.py /large/video/directory
# Output: "Resuming scan from previous session... Already processed: 1247 files"

# Or start fresh (ignoring previous progress)
python3 cli_handler.py --no-resume /large/video/directory
```

## Project Structure

```
├── cli_handler.py      # Main CLI entry point
├── video_inspector.py  # Core video inspection logic
├── utils.py           # Utility functions
├── tests/             # Integration tests
│   ├── test_utils_integration.py
│   ├── test_video_inspector_integration.py
│   ├── test_cli_integration.py
│   ├── test_end_to_end_integration.py
│   ├── run_tests.py   # Test runner
│   └── README.md      # Test documentation
├── pyproject.toml     # Modern Python packaging and tool configuration
├── Dockerfile         # Docker container configuration
└── README.md          # This file
```

## Requirements

- Python 3.8+
- FFmpeg (automatically included in Docker image)
