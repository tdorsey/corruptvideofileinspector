services:
  scan:
    image: cvi:${APP_VERSION:-1.0.0}
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: production
      args:
        APP_VERSION: "${APP_VERSION:-1.0.0}"
        APP_TITLE: "corrupt-video-inspector"
        APP_DESCRIPTION: "A Docker-based tool to detect and report corrupt video files using FFmpeg"
    container_name: scan
    user: "${PUID:-1000}:${PGID:-1000}"
    command:
      - scan
      - --directory
      - /app/videos
    volumes:
      - type: bind
        source: ${COMPOSE_PROJECT_DIR}/config.yaml
        target: /app/config.yaml
        read_only: true
      - video_data:/app/videos:ro
      - output:/app/output
      - logs:/app/logs
    environment:
      - TRAKT_CLIENT_ID=test_client_id
      - PYTHONUNBUFFERED=1
    secrets:
      - trakt_client_id
      - trakt_client_secret

  report:
    extends: scan
    container_name: report
    command:
      - report
      - --scan-file
      - /app/output/scan_results.json
      - --format
      - json

  trakt:
    extends: scan
    container_name: trakt-sync
    command:
      - trakt
      - sync
      - /app/output/scan_results.json
    environment:
      - TRAKT_CLIENT_ID=${TRAKT_CLIENT_ID:-}
      - PYTHONUNBUFFERED=1
    depends_on:
      - scan
    profiles:
      - trakt

# Docker secrets configuration
secrets:
  trakt_client_id:
    file: ./secrets/trakt_client_id.txt
  trakt_client_secret:
    file: ./secrets/trakt_client_secret.txt

volumes:
  video_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${CVI_VIDEO_DIR:?'CVI_VIDEO_DIR environment variable not set'}
  output:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${CVI_OUTPUT_DIR:?'CVI_OUTPUT_DIR environment variable not set'}
  logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${CVI_LOG_DIR:?'CVI_LOG_DIR environment variable not set'}
  # Development volumes
  dev_videos:
    driver: local
  dev_output:
    driver: local
