name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop, next ]
  pull_request:
    branches: [ main, develop, next ]

env:
  NX_CLOUD_ACCESS_TOKEN: ${{ secrets.NX_CLOUD_ACCESS_TOKEN }}
  NX_BRANCH: ${{ github.head_ref || github.ref_name }}

jobs:
  # PR title validation (skip for pushes and draft PRs)
  validate-pr-title:
    name: Validate PR Title
    runs-on: ubuntu-latest
    # Skip for pushes and draft PRs
    if: github.event_name != 'pull_request' || github.event.pull_request.draft == false

    steps:
      - name: Skip for pushes
        if: github.event_name != 'pull_request'
        run: echo "Skipping PR title validation for push events"

      - name: Validate PR title
        if: github.event_name == 'pull_request'
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # Define the allowed conventional commit types based on the
          # project's issue templates
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            chore
            ci
          # Allow scopes (optional part after type)
          requireScope: false
          # Disallow release-related types since this is handled by
          # automated releases
          disallowScopes: |
            release
          # Validate that the subject starts with lowercase
          subjectPattern: ^(?![A-Z]).+$
          subjectPatternError: |
            The subject "{subject}" found in the pull request title "{title}"
            didn't match the configured pattern. Please ensure that the subject
            starts with a lowercase letter.
          # Ignore merge commits and dependabot PRs
          ignoreLabels: |
            bot
            ignore-semantic-pr
          # Validate PR body contains issue reference
          validateSingleCommit: false

      - name: Validate issue reference
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.pull_request.title || '';
            const body = context.payload.pull_request.body || '';
            const branchName = context.payload.pull_request.head.ref || '';

            // Debug output
            console.log('=== DEBUG: PR Information ===');
            console.log(`Title: "${title}"`);
            console.log(`Title length: ${title.length}`);
            console.log(`Body length: ${body.length}`);
            console.log(`Branch: "${branchName}"`);
            
            // Show first and last 100 chars of body for debugging
            if (body.length > 0) {
              console.log(`Body start: "${body.substring(0, 100)}"`);
              if (body.length > 100) {
                console.log(`Body end: "${body.substring(body.length - 100)}"`);
              }
            } else {
              console.log('Body is empty or null');
            }

            // Check for issue reference in title, body, or branch name
            const issueRefPattern = /#(\d+)/;
            const branchIssuePattern = /(?:issue-|fix-|feature-|bug-|hotfix-)(\d+)/i;
            let foundIssueNumber = null;
            let foundLocation = null;

            // Try to extract issue number from title
            let match = title.match(issueRefPattern);
            if (match) {
              foundIssueNumber = match[1];
              foundLocation = 'title';
              console.log(`✅ Issue reference found in title: #${foundIssueNumber}`);
            }
            
            // Try to extract from body if not found
            if (!foundIssueNumber && body.length > 0) {
              match = body.match(issueRefPattern);
              if (match) {
                foundIssueNumber = match[1];
                foundLocation = 'body';
                console.log(`✅ Issue reference found in body: #${foundIssueNumber}`);
                
                // Find the exact position in body for debugging
                const index = body.search(issueRefPattern);
                console.log(`Issue reference position in body: ${index}`);
                const context_start = Math.max(0, index - 20);
                const context_end = Math.min(body.length, index + 30);
                console.log(`Body context: "${body.substring(context_start, context_end)}"`);
              }
            }
            
            // Try to extract from branch name if not found
            if (!foundIssueNumber) {
              match = branchName.match(issueRefPattern);
              if (match) {
                foundIssueNumber = match[1];
                foundLocation = 'branch (direct)';
                console.log(`✅ Issue reference found in branch name: #${foundIssueNumber}`);
              } else {
                match = branchName.match(branchIssuePattern);
                if (match) {
                  foundIssueNumber = match[1];
                  foundLocation = 'branch (pattern)';
                  console.log(`✅ Issue reference found in branch pattern: #${foundIssueNumber}`);
                }
              }
            }

            // Final validation
            if (!foundIssueNumber) {
              console.log('❌ No issue reference found in title, body, or branch name');
              console.log('=== DEBUG: Testing patterns manually ===');
              console.log(`Title test: ${issueRefPattern.test(title)}`);
              console.log(`Body test: ${issueRefPattern.test(body)}`);
              console.log(`Branch test: ${issueRefPattern.test(branchName) || branchIssuePattern.test(branchName)}`);
              
              core.setFailed(
                'PR must reference an issue number (e.g., #123) either in ' +
                'the title, body, or branch name. Examples:\n' +
                '- Title: "feat: add new feature (#123)"\n' +
                '- Body: "Fixes #123" or "Closes #123"\n' +
                '- Branch: "issue-123-description" or "fix-123-bug"'
              );
              return;
            }

            console.log(`✅ Issue reference validation passed`);
            console.log(`Found issue #${foundIssueNumber} in ${foundLocation}`);

  lint-and-format:
    name: Lint, Format, and Type Check
    runs-on: ubuntu-latest
    # Always depend on PR title validation, but it will be skipped for pushes and drafts
    needs: validate-pr-title

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Required for Nx affected commands
        submodules: recursive  # Initialize Ralph submodule

    - name: Validate Ralph submodule is pinned to release tag
      run: |
        set -e
        if [ -d "tools/ralph/ralph-cli" ]; then
          cd tools/ralph/ralph-cli
          # Check if current commit is tagged with a release
          if ! git describe --tags --exact-match 2>/dev/null; then
            echo "ERROR: Ralph submodule is not pinned to a release tag"
            echo "Current commit: $(git rev-parse HEAD)"
            echo "Please pin the submodule to a release tag, not a branch"
            echo ""
            echo "To fix:"
            echo "  cd tools/ralph/ralph-cli"
            echo "  git fetch --tags"
            echo "  git checkout <release-tag>  # e.g., v1.0.0"
            echo "  cd ../../.."
            echo "  git add tools/ralph/ralph-cli"
            echo "  git commit -m 'fix(ralph): pin submodule to release tag'"
            exit 1
          fi
          TAG=$(git describe --tags --exact-match)
          echo "✅ Ralph submodule is correctly pinned to release tag: ${TAG}"
          cd ../../..
        else
          echo "ℹ️ Ralph submodule not yet initialized (expected during initial setup)"
        fi

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install Node dependencies
      run: npm ci

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'pip'

    - name: Restore Nx cache
      uses: actions/cache@v4
      with:
        path: .nx/cache
        key: nx-cache-${{ runner.os }}-${{ hashFiles('**/package-lock.json', '**/pyproject.toml') }}
        restore-keys: |
          nx-cache-${{ runner.os }}-

    - name: Install dependencies
      run: |
        set -e
        make install-dev

    - name: Lint and Format
      run: |
        set -e
        make lint

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    # Security scan should run in parallel with linting, after PR validation
    needs: validate-pr-title

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive  # Initialize Ralph submodule

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install dependencies
      run: |
        set -e
        make install-dev

    - name: Run Security Scan
      run: |
        set -e
        make security-scan

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    # Tests should run after both linting and security scanning pass
    needs: [lint-and-format, security]

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Required for Nx affected commands
        submodules: recursive  # Initialize Ralph submodule

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install Node dependencies
      run: npm ci

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'pip'

    - name: Restore Nx cache
      uses: actions/cache@v4
      with:
        path: .nx/cache
        key: nx-cache-${{ runner.os }}-${{ hashFiles('**/package-lock.json', '**/pyproject.toml') }}
        restore-keys: |
          nx-cache-${{ runner.os }}-

    - name: Install system dependencies
      run: |
        set -e
        sudo apt-get update && sudo apt-get install -y ffmpeg

    - name: Setup test configuration
      run: |
        set -e
        cp config.sample.yaml config.yaml

    - name: Install dependencies
      run: |
        set -e
        make install-dev

    - name: Run Tests
      run: |
        set -e
        make test

  docker:
    name: Build and Test Docker Image
    runs-on: ubuntu-latest
    # Docker build should only occur after all tests pass
    needs: test

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive  # Initialize Ralph submodule

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: network=host

    - name: Cache Docker layers
      uses: actions/cache@v4
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ hashFiles('**/Dockerfile', '**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-buildx-

    - name: Build Docker image
      run: |
        set -e
        make docker-build

    - name: Test Docker image
      run: |
        set -e
        make docker-test
