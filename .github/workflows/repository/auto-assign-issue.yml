name: Auto-Assign Issues

"on":
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read

jobs:
  auto-assign:
    runs-on: ubuntu-latest
    steps:
      - name: Auto-assign Issue to Copilot
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const commentMarker = '<!-- auto-assign-comment -->';
            
            const minimizeComment = async (nodeId) => {
              if (!nodeId) {
                return;
              }
              try {
                await github.graphql(
                  `mutation($subjectId:ID!, $classifier:ReportedContentClassifiers!) {
                    minimizeComment(input:{subjectId:$subjectId, classifier:$classifier}) {
                      minimizedComment { isMinimized }
                    }
                  }`,
                  { subjectId: nodeId, classifier: 'OUTDATED' }
                );
              } catch (error) {
                console.log('Unable to minimize assignment comment:', error.message);
              }
            };
            
            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: issueNumber,
              per_page: 100
            });
            
            const existingComment = comments.find(comment =>
              comment.body &&
              (comment.body.includes(commentMarker) ||
                comment.body.includes('ü§ñ **Issue Assigned to Copilot**') ||
                comment.body.includes('‚ö†Ô∏è **Auto-assignment Notice**'))
            );
            
            try {
              // Assign the issue to @copilot
              await github.rest.issues.addAssignees({
                owner,
                repo,
                issue_number: issueNumber,
                assignees: ['copilot']
              });
              
              console.log(`‚úÖ Successfully assigned issue #${issueNumber} to @copilot`);
              
              // Add a welcome comment
              const welcomeComment = [
                commentMarker,
                'ü§ñ **Issue Assigned to Copilot**',
                '',
                'Thank you for opening this issue! This has been automatically assigned to @copilot for review and assistance.',
                '',
                '## Next Steps',
                '- @copilot will review this issue and provide guidance',
                '- If you\'d like to work on this yourself, feel free to comment and request assignment',
                `- Follow the [development guidelines](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/.github/copilot-instructions.md) when contributing`,
                '',
                'Happy coding! üöÄ'
              ].join('\n');

              if (existingComment) {
                await minimizeComment(existingComment.node_id);
              } else {
                const { data: welcomeCommentData } = await github.rest.issues.createComment({
                  issue_number: issueNumber,
                  owner,
                  repo,
                  body: welcomeComment
                });
                
                await minimizeComment(welcomeCommentData.node_id);
              }
              
              console.log(`‚úÖ Posted welcome comment on issue #${issueNumber}`);
              
            } catch (error) {
              console.error('‚ùå Error assigning issue or posting comment:', error.message);
              
              // Still try to post a comment even if assignment fails
              try {
                const fallbackComment = [
                  commentMarker,
                  '‚ö†Ô∏è **Auto-assignment Notice**',
                  '',
                  'There was an issue with automatic assignment, but this issue has been logged for review.',
                  '',
                  'A maintainer will review this issue and assign it appropriately.',
                  '',
                  'Thank you for your contribution! üôè'
                ].join('\n');

                if (existingComment) {
                  await minimizeComment(existingComment.node_id);
                } else {
                  const { data: fallbackCommentData } = await github.rest.issues.createComment({
                    issue_number: issueNumber,
                    owner,
                    repo,
                    body: fallbackComment
                  });
                  
                  await minimizeComment(fallbackCommentData.node_id);
                }
                
                console.log(`‚úÖ Posted fallback comment on issue #${issueNumber}`);
              } catch (commentError) {
                console.error('‚ùå Error posting fallback comment:', commentError.message);
              }
            }
