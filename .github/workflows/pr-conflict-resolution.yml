name: ðŸ”§ PR Conflict Resolution Labeler

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  label-merge-conflicts:
    runs-on: ubuntu-latest
    steps:
      - name: Label merge conflicts and assign agent
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = context.payload.pull_request.number;
            const conflictLabel = 'status:merge-conflict';
            const agentAssignee = 'Copilot';

            const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));
            const fetchPr = async () => {
              const response = await github.rest.pulls.get({
                owner,
                repo,
                pull_number: prNumber
              });
              return response.data;
            };

            let pr = await fetchPr();
            let attempts = 0;

            while (pr.mergeable === null && attempts < 5) {
              await wait(2000);
              pr = await fetchPr();
              attempts += 1;
            }

            const hasConflicts = pr.mergeable === false || pr.mergeable_state === 'dirty';
            const labelNames = pr.labels.map(label => label.name);
            const hasConflictLabel = labelNames.includes(conflictLabel);
            const assigneeLogins = pr.assignees.map(assignee => assignee.login.toLowerCase());
            const hasAssignee = assigneeLogins.includes(agentAssignee.toLowerCase());

            if (hasConflicts) {
              if (!hasConflictLabel) {
                await github.rest.issues.addLabels({
                  owner,
                  repo,
                  issue_number: prNumber,
                  labels: [conflictLabel]
                });
              }

              if (!hasAssignee) {
                await github.rest.issues.addAssignees({
                  owner,
                  repo,
                  issue_number: prNumber,
                  assignees: [agentAssignee]
                });
              }

              console.log('PR has merge conflicts; label and assignee ensured.');
              return;
            }

            if (pr.mergeable === true && hasConflictLabel) {
              try {
                await github.rest.issues.removeLabel({
                  owner,
                  repo,
                  issue_number: prNumber,
                  name: conflictLabel
                });
              } catch (error) {
                const status = error?.status ?? error?.response?.status;
                if (status !== 404) {
                  throw error;
                }
              }
            }

            console.log('Mergeable status is clean; conflict label updated if needed.');
